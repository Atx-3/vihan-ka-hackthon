<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Healthy Her</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* --- GLOBAL STYLES --- */
        body {
            -webkit-tap-highlight-color: transparent;
            background-color: #f8fafc;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        /* Custom scrollbar */
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }

        /* Animations */
        .fade-in { animation: fadeIn 0.4s ease-in-out; }
        .slide-up { animation: slideUp 0.3s ease-out; }
        .zoom-in { animation: zoomIn 0.2s ease-out; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        @keyframes zoomIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* Chat Bubbles */
        .msg-bubble { max-width: 80%; padding: 10px 14px; border-radius: 16px; font-size: 14px; line-height: 1.5; position: relative; box-shadow: 0 1px 2px rgba(0,0,0,0.05); word-wrap: break-word; }
        .msg-sent { background: linear-gradient(135deg, #f43f5e, #e11d48); color: white; align-self: flex-end; border-bottom-right-radius: 4px; }
        .msg-received { background-color: white; color: #374151; align-self: flex-start; border: 1px solid #e5e7eb; border-bottom-left-radius: 4px; }

        /* Glassmorphism */
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        /* Toast Notification */
        #toast-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 9999; display: flex; flex-direction: column; gap: 10px; pointer-events: none; width: 90%; max-width: 350px; }
        .toast { background: #1f2937; color: white; padding: 12px 20px; border-radius: 50px; font-size: 14px; font-weight: 500; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); animation: slideDown 0.3s ease-out forwards; pointer-events: auto; display: flex; align-items: center; gap: 10px; justify-content: center; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }

        /* Call Controls */
        .call-btn { transition: all 0.2s ease; }
        .call-btn:active { transform: scale(0.9); }
        .call-btn-active { background-color: white; color: #dc2626; }
        .call-btn-inactive { background-color: rgba(255, 255, 255, 0.2); color: white; backdrop-filter: blur(4px); }
        
        /* Cart Badge */
        .cart-badge { position: absolute; top: -6px; right: -6px; background-color: #ef4444; color: white; border-radius: 9999px; width: 20px; height: 20px; font-size: 11px; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    </style>
</head>
<body class="text-gray-800 font-sans min-h-screen relative pb-24 md:pb-0">

    <div id="app"></div>
    <div id="chat-container"></div>
    <div id="video-call-container"></div>
    <div id="toast-container"></div>

    <script>
        // ==========================================
        // 1. DATA & CONSTANTS
        // ==========================================

        const DOCTORS = [
            { id: 1, name: "Dr. Sarah Johnson", specialty: "Gynecologist", rating: 4.9, distance: "1.2 km", available: true, image: "https://api.dicebear.com/7.x/avataaars/svg?seed=Sarah&backgroundColor=c0aede" },
            { id: 2, name: "Dr. Emily Chen", specialty: "Endocrinologist (PCOS)", rating: 4.8, distance: "3.5 km", available: false, image: "https://api.dicebear.com/7.x/avataaars/svg?seed=Emily&backgroundColor=ffdfbf" },
            { id: 3, name: "Dr. Priya Patel", specialty: "Gen. Physician", rating: 4.7, distance: "0.8 km", available: true, image: "https://api.dicebear.com/7.x/avataaars/svg?seed=Priya&backgroundColor=b6e3f4" },
            { id: 4, name: "Dr. Anita Roy", specialty: "Therapist", rating: 4.9, distance: "2.0 km", available: true, image: "https://api.dicebear.com/7.x/avataaars/svg?seed=Anita&backgroundColor=ffdfbf" },
        ];

        const MEDICINES = [
            { id: 101, name: "Paracetamol 650", type: "Tablet", price: 30, image: "https://ui-avatars.com/api/?name=P&background=e11d48&color=fff&size=128&font-size=0.5" },
            { id: 102, name: "Sanitary Pads XL", type: "Hygiene", price: 199, image: "https://ui-avatars.com/api/?name=S&background=ec4899&color=fff&size=128&font-size=0.5" },
            { id: 103, name: "Iron & Folic Acid", type: "Supplement", price: 150, image: "https://ui-avatars.com/api/?name=Fe&background=22c55e&color=fff&size=128&font-size=0.5" },
            { id: 104, name: "Hot Water Bag", type: "Pain Relief", price: 299, image: "https://ui-avatars.com/api/?name=H&background=f97316&color=fff&size=128&font-size=0.5" },
            { id: 105, name: "PCOS Balance Tea", type: "Wellness", price: 450, image: "https://ui-avatars.com/api/?name=T&background=a855f7&color=fff&size=128&font-size=0.5" },
            { id: 106, name: "Vitamin D3", type: "Supplement", price: 120, image: "https://ui-avatars.com/api/?name=D3&background=eab308&color=fff&size=128&font-size=0.5" },
        ];

        const HEALTH_TOPICS = [
            { id: 'pcos', title: "PCOS Awareness", icon: "activity", color: "text-purple-600", description: "Manage hormonal balance.", details: "Polycystic Ovary Syndrome affects 1 in 10 women. Early diagnosis is key.", fullArticle: "<h4 class='font-bold text-xl mb-3 text-rose-600'>Understanding PCOS</h4><p class='text-gray-600 leading-relaxed mb-4'>PCOS is a hormonal disorder common among women of reproductive age. Women with PCOS may have infrequent or prolonged menstrual periods or excess male hormone (androgen) levels.</p><h4 class='font-bold text-xl mb-3 text-rose-600'>Lifestyle Changes</h4><ul class='list-disc pl-5 space-y-2 text-gray-600'><li>Maintain a healthy weight</li><li>Limit carbohydrates</li><li>Be active</li></ul>" },
            { id: 'breast', title: "Breast Health", icon: "heart", color: "text-pink-500", description: "Monthly self-checks.", details: "Regular exams help detecting changes early.", fullArticle: "<h4 class='font-bold text-xl mb-3 text-rose-600'>Self-Exam Guide</h4><p class='text-gray-600 leading-relaxed mb-4'>Adult women of all ages are encouraged to perform breast self-exams at least once a month.</p>" },
            { id: 'pregnancy', title: "Pregnancy", icon: "baby", color: "text-green-500", description: "Guide for moms-to-be.", details: "Track weekly growth and nutrition.", fullArticle: "<h4 class='font-bold text-xl mb-3 text-rose-600'>Healthy Pregnancy</h4><p class='text-gray-600'>Eat a balanced diet, stay hydrated, and take prenatal vitamins.</p>" },
            { id: 'mental', title: "Mental Wellness", icon: "smile", color: "text-yellow-500", description: "Stress & mood tracker.", details: "Your mental health is as important as physical health.", fullArticle: "<h4 class='font-bold text-xl mb-3 text-rose-600'>Mental Health</h4><p class='text-gray-600'>Practice mindfulness and seek help if you feel overwhelmed.</p>" },
            { id: 'thyroid', title: "Thyroid Health", icon: "shield-alert", color: "text-blue-500", description: "Metabolic health.", details: "Impacts weight and energy.", fullArticle: "<h4 class='font-bold text-xl mb-3 text-rose-600'>Thyroid Function</h4><p class='text-gray-600'>The thyroid regulates metabolism. Disorders are common in women.</p>" }
        ];

        const SYMPTOMS_ADVICE = { "Cramps": "Use heat patch.", "Bloating": "Reduce salt.", "Headache": "Hydrate & rest.", "Acne": "Keep skin clean.", "Fatigue": "Sleep more." };
        const DAILY_TIPS = [ { icon: "sun", title: "Morning Sunshine", text: "Get 10m sun." }, { icon: "glass-water", title: "Hydration", text: "Drink water." }, { icon: "moon", title: "Sleep Hygiene", text: "No screens 1hr pre-bed." } ];
        const PERIOD_TIPS = [ { icon: "coffee", title: "Manage Cramps", text: "Chamomile tea." }, { icon: "battery-charging", title: "Rest", text: "Low energy is normal." }, { icon: "droplet", title: "Hygiene", text: "Change pads often." } ];

        // ==========================================
        // 2. STATE MANAGEMENT
        // ==========================================

        const state = {
            user: null, activeTab: 'dashboard', authStep: 1,
            authName: '', authAddress: '', authPhone: '', authOtp: '', authLoading: false,
            
            // Cycle Data
            currentDate: new Date(), cycleData: {}, cycleLength: 28, periodLength: 5, selectedDateDetails: null,
            
            // Learn Section
            expandedTopicId: null, activeArticle: null, 

            // Services & Doctor Chat
            serviceView: 'menu', activeDoctor: null, bookedDoctors: [], doctorChatMessages: {}, 
            
            // Pharmacy Cart
            cart: [],

            // Video/Voice Call State
            isVideoCallActive: false, callType: 'video', isMuted: false, isVideoPaused: false, localStream: null,

            // AI Assistant Chat
            chatOpen: false, chatInput: '', chatMessages: [{ id: 1, sender: 'bot', text: "Hi! I'm your health assistant." }],

            // Daily Trackers
            waterIntake: 0, dailyMood: 'Happy',
        };

        // ==========================================
        // 3. HELPER FUNCTIONS
        // ==========================================

        function showNotification(message) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.innerHTML = `<i data-lucide="info" width="16"></i> ${message}`;
            container.appendChild(toast);
            lucide.createIcons();
            setTimeout(() => { toast.style.opacity = '0'; toast.style.transform = 'translateY(-20px)'; toast.style.transition = 'all 0.3s ease'; setTimeout(() => toast.remove(), 300); }, 3000);
        }

        // Cycle Logic Engine
        function getCycleStats() {
            const dates = Object.keys(state.cycleData).sort();
            if(dates.length===0) return null;
            let lastStart = null;
            for(let i=dates.length-1; i>=0; i--){
                const k = dates[i];
                if(state.cycleData[k].flow) {
                    const d = new Date(k); d.setDate(d.getDate()-1);
                    const pk = `${d.getFullYear()}-${d.getMonth()}-${d.getDate()}`;
                    if(!state.cycleData[pk]?.flow) { lastStart = new Date(k); break; }
                }
            }
            if(!lastStart) return null;
            const diff = Math.floor((new Date() - lastStart)/(1000*60*60*24)) + 1;
            let phase = diff<=5?'Menstrual': diff<=13?'Follicular': diff===14?'Ovulation': 'Luteal';
            const next = new Date(lastStart); next.setDate(next.getDate()+28);
            const daysNext = Math.ceil((next - new Date())/(1000*60*60*24));
            return { dayOfCycle: diff, phase, daysUntilNext: daysNext, fertility: (diff>=10&&diff<=16)?'High':'Low', progress: Math.min((diff/28)*100, 100) };
        }

        function isPredictedPeriod(targetDate) {
            const stats = getCycleStats(); if (!stats || targetDate <= stats.lastStartDate) return false;
            const diffTime = Math.abs(targetDate - stats.lastStartDate); const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            const dayInCycle = diffDays % state.cycleLength; return dayInCycle < state.periodLength;
        }

        function isPredictedOvulation(targetDate) {
            const stats = getCycleStats(); if (!stats || targetDate <= stats.lastStartDate) return false;
            const diffTime = Math.abs(targetDate - stats.lastStartDate); const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            const dayInCycle = diffDays % state.cycleLength; return dayInCycle === 13;
        }

        // Pharmacy Logic
        function addToCart(item) {
            const existing = state.cart.find(i => i.id === item.id);
            if(existing) existing.qty += 1; else state.cart.push({...item, qty: 1});
            showNotification("Added to Cart"); render();
        }
        function removeFromCart(id) { state.cart = state.cart.filter(i => i.id !== id); render(); }
        function placeOrder() {
            if(state.cart.length === 0) return showNotification("Cart is empty");
            state.cart = []; state.serviceView = 'pharmacy'; showNotification("Order Placed Successfully!"); render();
        }

        // ==========================================
        // 4. MAIN RENDER LOOP
        // ==========================================

        function render() {
            const app = document.getElementById('app');
            const chatContainer = document.getElementById('chat-container');
            const videoContainer = document.getElementById('video-call-container');
            
            if (!state.user) {
                app.innerHTML = renderAuthScreen();
                chatContainer.innerHTML = ''; chatContainer.className = ''; videoContainer.innerHTML = '';
            } else {
                app.innerHTML = `
                    ${renderHeader()}
                    <div class="flex min-h-screen pt-[76px]">
                        ${renderDesktopNav()}
                        <main class="flex-1 max-w-5xl mx-auto p-4 md:p-8 pb-28 md:pl-28">
                            ${renderContent()}
                        </main>
                    </div>
                    ${renderMobileNav()}
                    ${state.selectedDateDetails ? renderDayLogModal() : ''}
                    ${state.activeArticle ? renderArticleModal() : ''}
                `;
                renderChatWidget(); 
                
                // Render Video Call Overlay if Active
                if(state.isVideoCallActive) renderCallOverlay();
                else videoContainer.innerHTML = '';
            }
            lucide.createIcons();
        }

        // ==========================================
        // 5. VIEW COMPONENTS
        // ==========================================

        function renderAuthScreen() {
            return `<div class="min-h-screen bg-rose-50 flex flex-col items-center justify-center p-6 fade-in"><div class="bg-white p-10 rounded-3xl shadow-2xl w-full max-w-md border border-rose-100"><div class="flex justify-center mb-6"><div class="w-20 h-20 bg-rose-100 rounded-full flex items-center justify-center shadow-inner"><i data-lucide="heart" class="w-10 h-10 text-rose-500 fill-rose-500"></i></div></div><h1 class="text-3xl font-bold text-center text-gray-800 mb-2">Healthy Her</h1><p class="text-center text-gray-500 mb-8">Your Personal Health Companion</p>${state.authStep===1 ? `<form onsubmit="handleSendOtp(event)" class="space-y-5"><div><label class="block text-sm font-semibold text-gray-700 mb-1">Full Name</label><input type="text" value="${state.authName}" oninput="state.authName=this.value" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-rose-500 outline-none" placeholder="Jane Doe"/></div><div><label class="block text-sm font-semibold text-gray-700 mb-1">Address</label><div class="flex gap-2"><input type="text" value="${state.authAddress}" oninput="state.authAddress=this.value" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-rose-500 outline-none" placeholder="City"/><button type="button" onclick="fetchLocation()" class="bg-gray-100 hover:bg-gray-200 p-3 rounded-xl transition-colors"><i data-lucide="map-pin" class="w-5 h-5 text-gray-600"></i></button></div></div><div><label class="block text-sm font-semibold text-gray-700 mb-1">Mobile</label><input type="tel" value="${state.authPhone}" oninput="state.authPhone=this.value" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-rose-500 outline-none" placeholder="Phone"/></div><button type="submit" class="w-full bg-gradient-to-r from-rose-500 to-pink-600 text-white py-3.5 rounded-xl font-bold shadow-lg hover:shadow-xl transition-all transform hover:-translate-y-0.5">${state.authLoading?'Sending...':'Continue'}</button></form>` : `<form onsubmit="handleVerifyOtp(event)" class="space-y-5"><div class="text-center mb-4"><p class="text-sm text-gray-500">Enter code</p></div><div><input type="text" value="${state.authOtp}" oninput="state.authOtp=this.value" class="w-full px-4 py-3 border border-gray-200 rounded-xl text-center text-2xl tracking-widest focus:ring-2 focus:ring-rose-500 outline-none" placeholder="XXXX" autofocus/></div><button type="submit" class="w-full bg-gradient-to-r from-rose-500 to-pink-600 text-white py-3.5 rounded-xl font-bold shadow-lg hover:shadow-xl transition-all">Verify</button></form>`}</div></div>`;
        }

        function renderHeader() { return `<header class="bg-white/90 backdrop-blur-md shadow-sm fixed top-0 left-0 right-0 z-30 px-6 h-[76px] flex justify-between items-center border-b border-gray-100"><div class="flex items-center gap-3"><div class="bg-rose-100 p-2 rounded-lg"><i data-lucide="heart" class="w-6 h-6 text-rose-600 fill-rose-600"></i></div><h1 class="text-xl font-bold bg-gradient-to-r from-rose-600 to-purple-600 bg-clip-text text-transparent">Healthy Her</h1></div><div class="flex items-center gap-4"><div class="text-right hidden md:block"><p class="text-sm font-bold text-gray-800">${state.user.name}</p><p class="text-xs text-gray-500 flex items-center justify-end gap-1"><i data-lucide="map-pin" width="10"></i> ${state.user.address.split(',')[0]}</p></div><div class="w-10 h-10 bg-gradient-to-br from-rose-400 to-purple-500 rounded-full flex items-center justify-center text-white font-bold text-lg shadow-md">${state.user.name[0]}</div></div></header>`; }
        function renderDesktopNav() { const t = [{id:'dashboard',i:'layout-grid',l:'Home'},{id:'tracker',i:'calendar-heart',l:'Cycle'},{id:'health',i:'book-open',l:'Learn'},{id:'services',i:'stethoscope',l:'Services'}]; return `<div class="hidden md:flex fixed left-0 top-[76px] bottom-0 w-24 bg-white border-r border-gray-200 flex-col items-center pt-8 gap-6 z-20 shadow-sm">${t.map(x=>`<button onclick="setActiveTab('${x.id}')" class="flex flex-col items-center gap-1.5 p-3 rounded-xl transition-all w-16 ${state.activeTab===x.id?'bg-rose-50 text-rose-600 shadow-sm':'text-gray-400 hover:bg-gray-50 hover:text-gray-600'}"><i data-lucide="${x.i}" width="24"></i><span class="text-[10px] font-semibold">${x.l}</span></button>`).join('')}</div>`; }
        function renderMobileNav() { const t = [{id:'dashboard',i:'layout-grid',l:'Home'},{id:'tracker',i:'calendar-heart',l:'Cycle'},{id:'health',i:'book-open',l:'Learn'},{id:'services',i:'stethoscope',l:'Services'}]; return `<nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 px-6 py-3 flex justify-between items-end z-40 md:hidden pb-safe shadow-[0_-4px_20px_rgba(0,0,0,0.05)]"><div class="flex gap-6">${t.slice(0,2).map(x=>`<button onclick="setActiveTab('${x.id}')" class="flex flex-col items-center gap-1 ${state.activeTab===x.id?'text-rose-600':'text-gray-400'}"><i data-lucide="${x.i}" width="24"></i><span class="text-[10px] font-medium">${x.l}</span></button>`).join('')}</div><div class="relative -top-8"><button onclick="toggleChat()" class="bg-gradient-to-r from-rose-500 to-pink-600 text-white w-14 h-14 rounded-full shadow-lg flex items-center justify-center border-4 border-gray-50 transform transition-transform active:scale-95"><i data-lucide="message-square-plus" width="26"></i></button></div><div class="flex gap-6">${t.slice(2).map(x=>`<button onclick="setActiveTab('${x.id}')" class="flex flex-col items-center gap-1 ${state.activeTab===x.id?'text-rose-600':'text-gray-400'}"><i data-lucide="${x.i}" width="24"></i><span class="text-[10px] font-medium">${x.l}</span></button>`).join('')}</div></nav>`; }

        function renderContent() {
            if(state.activeTab==='services') return renderServicesView();
            if(state.activeTab==='tracker') return renderTrackerView();
            if(state.activeTab==='health') return renderLearnView();
            return renderDashboardView();
        }

        // --- DASHBOARD ---
        function renderDashboardView() {
            const h = new Date().getHours();
            const greeting = h<12?'Good Morning':h<17?'Good Afternoon':h<21?'Good Evening':'Good Night';
            const stats = getCycleStats();
            const tip = (stats && stats.dayOfCycle<=5) ? PERIOD_TIPS[0] : DAILY_TIPS[0];

            return `
                <div class="space-y-8 fade-in pb-20">
                    <!-- Hero Section -->
                    <div class="glass-card rounded-3xl p-6 md:p-8 bg-gradient-to-br from-rose-500 via-pink-500 to-purple-600 text-white shadow-xl relative overflow-hidden">
                        <div class="absolute top-0 right-0 w-64 h-64 bg-white opacity-10 rounded-full -mr-16 -mt-16 blur-3xl"></div>
                        <div class="relative z-10">
                            <div class="flex justify-between items-start mb-6">
                                <div>
                                    <p class="text-rose-100 text-sm font-medium mb-1">${new Date().toLocaleDateString('en-US', {weekday:'long', day:'numeric', month:'long'})}</p>
                                    <h2 class="text-3xl font-bold">${greeting}, ${state.user.name.split(' ')[0]}</h2>
                                </div>
                            </div>
                            ${stats ? `
                                <div class="flex flex-col md:flex-row gap-6 items-center">
                                    <div class="relative w-32 h-32 flex items-center justify-center">
                                        <svg class="w-full h-full transform -rotate-90"><circle cx="64" cy="64" r="58" stroke="currentColor" stroke-width="8" fill="transparent" class="text-white/20" /><circle cx="64" cy="64" r="58" stroke="white" stroke-width="8" fill="transparent" stroke-dasharray="364" stroke-dashoffset="${364 - (364 * stats.progress / 100)}" stroke-linecap="round" /></svg>
                                        <div class="absolute text-center"><span class="text-3xl font-bold block shadow-sm">Day ${stats.dayOfCycle}</span></div>
                                    </div>
                                    <div class="flex-1 grid grid-cols-2 gap-4 w-full md:w-auto">
                                        <div class="bg-white/10 backdrop-blur-md rounded-2xl p-4 border border-white/10"><span class="text-xs text-rose-100 uppercase tracking-wider">Phase</span><p class="text-lg font-bold mt-1">${stats.phase}</p></div>
                                        <div class="bg-white/10 backdrop-blur-md rounded-2xl p-4 border border-white/10"><span class="text-xs text-rose-100 uppercase tracking-wider">Next Period</span><p class="text-lg font-bold mt-1">${stats.daysUntilNext} Days</p></div>
                                    </div>
                                </div>
                            ` : `
                                <div class="text-center py-8"><p class="mb-4 text-lg opacity-90">Track your cycle to get personalized insights.</p><button onclick="logPeriodStartToday()" class="bg-white text-rose-600 px-8 py-3 rounded-full font-bold shadow-lg hover:bg-gray-50 transition-transform active:scale-95">Log Period Start</button></div>
                            `}
                        </div>
                    </div>
                    
                    <!-- Quick Actions Grid -->
                    <div>
                        <h3 class="text-lg font-bold text-gray-800 mb-4 px-2">Quick Actions</h3>
                        <div class="grid grid-cols-4 gap-3 md:gap-6">
                            <button onclick="setActiveTab('tracker')" class="flex flex-col items-center gap-2 p-4 bg-white rounded-2xl shadow-sm border border-gray-100 hover:shadow-md transition-all group"><div class="w-12 h-12 rounded-full bg-rose-50 text-rose-500 flex items-center justify-center group-hover:scale-110 transition-transform"><i data-lucide="calendar-heart"></i></div><span class="text-xs font-semibold text-gray-600">Log Cycle</span></button>
                            <button onclick="setServiceView('doctors'); setActiveTab('services')" class="flex flex-col items-center gap-2 p-4 bg-white rounded-2xl shadow-sm border border-gray-100 hover:shadow-md transition-all group"><div class="w-12 h-12 rounded-full bg-blue-50 text-blue-500 flex items-center justify-center group-hover:scale-110 transition-transform"><i data-lucide="stethoscope"></i></div><span class="text-xs font-semibold text-gray-600">Consult</span></button>
                            <button onclick="setServiceView('pharmacy'); setActiveTab('services')" class="flex flex-col items-center gap-2 p-4 bg-white rounded-2xl shadow-sm border border-gray-100 hover:shadow-md transition-all group"><div class="w-12 h-12 rounded-full bg-green-50 text-green-500 flex items-center justify-center group-hover:scale-110 transition-transform"><i data-lucide="pill"></i></div><span class="text-xs font-semibold text-gray-600">Medicine</span></button>
                            <button onclick="setActiveTab('health')" class="flex flex-col items-center gap-2 p-4 bg-white rounded-2xl shadow-sm border border-gray-100 hover:shadow-md transition-all group"><div class="w-12 h-12 rounded-full bg-purple-50 text-purple-500 flex items-center justify-center group-hover:scale-110 transition-transform"><i data-lucide="sparkles"></i></div><span class="text-xs font-semibold text-gray-600">Learn</span></button>
                        </div>
                    </div>

                    <!-- Daily Wellness -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-white rounded-3xl p-6 shadow-sm border border-gray-100">
                            <div class="flex justify-between items-center mb-4"><h3 class="font-bold text-gray-800 flex items-center gap-2"><i data-lucide="glass-water" class="text-blue-400"></i> Water</h3><span class="text-sm font-bold text-blue-600">${state.waterIntake}/8 Glasses</span></div>
                            <div class="flex items-end gap-1 h-24 mb-4 bg-blue-50/50 rounded-xl p-2 justify-between">${Array(8).fill(0).map((_,i) => `<div class="w-full bg-blue-100 rounded-t-md relative overflow-hidden cursor-pointer hover:opacity-80 transition-all" style="height: ${i < state.waterIntake ? '100%' : '20%'}; background-color: ${i < state.waterIntake ? '#3b82f6' : '#dbeafe'}" onclick="addWater(${i+1})"></div>`).join('')}</div>
                            <p class="text-xs text-gray-500 text-center">Tap bars to log water intake</p>
                        </div>
                        <div class="space-y-4">
                            <div class="bg-gradient-to-r from-indigo-50 to-purple-50 rounded-3xl p-6 border border-indigo-100 flex items-start gap-4"><div class="p-3 bg-white rounded-full shadow-sm text-indigo-500"><i data-lucide="${tip.icon}"></i></div><div><h4 class="font-bold text-gray-800 text-sm mb-1">${tip.title}</h4><p class="text-xs text-gray-600 leading-relaxed">${tip.text}</p></div></div>
                            <div class="bg-white rounded-3xl p-6 border border-gray-100 shadow-sm"><h3 class="font-bold text-gray-800 mb-3 text-sm">How do you feel today?</h3><div class="flex justify-between">${['ðŸ˜Š','ðŸ˜','ðŸ˜”','ðŸ˜¡','ðŸ˜´'].map(e => `<button onclick="setMood('${e}')" class="text-2xl hover:scale-125 transition-transform p-2 rounded-full hover:bg-gray-50 ${state.dailyMood===e?'bg-gray-100 scale-110':''}">${e}</button>`).join('')}</div></div>
                        </div>
                    </div>
                </div>
            `;
        }

        // --- Tracker View ---
        function renderTrackerView() {
            const days = new Date(state.currentDate.getFullYear(), state.currentDate.getMonth()+1, 0).getDate();
            const first = new Date(state.currentDate.getFullYear(), state.currentDate.getMonth(), 1).getDay();
            let html = ''; for(let i=0;i<first;i++) html+=`<div></div>`;
            for(let d=1;d<=days;d++) {
                const k = `${state.currentDate.getFullYear()}-${state.currentDate.getMonth()}-${d}`;
                const hasData = state.cycleData[k];
                const dot = hasData ? `<span class="w-1.5 h-1.5 rounded-full mt-1 mx-auto block ${hasData.flow==='Heavy'?'bg-rose-600':'bg-rose-400'}"></span>` : '';
                html+=`<button onclick="handleDateClick(${d})" class="h-12 rounded-xl hover:bg-rose-50 border border-transparent focus:border-rose-200 transition-all flex flex-col items-center justify-center"><span class="text-sm font-medium text-gray-700">${d}</span>${dot}</button>`;
            }
            return `<div class="space-y-6 fade-in pb-20"><div class="flex items-center justify-between"><h2 class="text-2xl font-bold text-gray-800">Cycle Tracker</h2></div><div class="bg-white rounded-3xl shadow-sm border border-gray-100 p-6"><div class="flex justify-between items-center mb-8"><button onclick="changeMonth(-1)" class="p-2 hover:bg-gray-100 rounded-full"><i data-lucide="chevron-left"></i></button><h2 class="text-lg font-bold text-gray-800">${state.currentDate.toLocaleString('default',{month:'long', year:'numeric'})}</h2><button onclick="changeMonth(1)" class="p-2 hover:bg-gray-100 rounded-full"><i data-lucide="chevron-right"></i></button></div><div class="grid grid-cols-7 gap-2 text-center text-xs font-bold text-gray-400 mb-4"><span>SUN</span><span>MON</span><span>TUE</span><span>WED</span><span>THU</span><span>FRI</span><span>SAT</span></div><div class="grid grid-cols-7 gap-2">${html}</div></div><div class="flex justify-center gap-6 text-xs text-gray-500"><div class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-rose-600"></span> Heavy</div><div class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-rose-400"></span> Light</div><div class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-purple-500"></span> Fertile</div></div></div>`;
        }

        function renderDayLogModal() { const {day,data}=state.selectedDateDetails; return `<div class="fixed inset-0 bg-black/40 backdrop-blur-sm z-50 flex items-end sm:items-center justify-center p-4 fade-in"><div class="bg-white w-full max-w-md rounded-3xl p-6 slide-up shadow-2xl"><div class="flex justify-between items-center mb-6"><h3 class="text-xl font-bold text-gray-800">Log for ${state.currentDate.toLocaleString('default',{month:'short'})} ${day}</h3><button onclick="closeModal()" class="p-2 bg-gray-100 rounded-full hover:bg-gray-200"><i data-lucide="x" width="20"></i></button></div><div class="space-y-6"><div class="space-y-3"><label class="text-sm font-bold text-gray-500 uppercase tracking-wider">Flow</label><div class="flex gap-2">${['None','Light','Medium','Heavy'].map(f=>`<button onclick="updateModalData('flow','${f}')" class="flex-1 py-3 rounded-xl text-sm font-medium transition-all ${data.flow===f?'bg-rose-500 text-white shadow-md transform scale-105':'bg-gray-50 text-gray-600 hover:bg-gray-100'}">${f}</button>`).join('')}</div></div><div class="space-y-3"><label class="text-sm font-bold text-gray-500 uppercase tracking-wider">Symptoms</label><div class="flex flex-wrap gap-2">${Object.keys(SYMPTOMS_ADVICE).map(s=>`<button onclick="toggleSymptom('${s}')" class="px-4 py-2 rounded-full text-sm border transition-colors ${(data.symptoms||[]).includes(s)?'bg-purple-100 border-purple-200 text-purple-700':'border-gray-200 text-gray-600 hover:bg-gray-50'}">${s}</button>`).join('')}</div></div><button onclick="saveLog()" class="w-full bg-gradient-to-r from-rose-500 to-pink-600 text-white py-4 rounded-2xl font-bold shadow-lg hover:shadow-xl active:scale-95 transition-all">Save Entry</button></div></div></div>`; }

        // --- Learn View ---
        function renderLearnView() { return `<div class="space-y-6 fade-in pb-20"><h2 class="text-2xl font-bold text-gray-800">Learn & Grow</h2><div class="grid gap-4">${HEALTH_TOPICS.map(t=>`<div class="bg-white rounded-2xl p-1 shadow-sm border border-gray-100 hover:shadow-md transition-shadow"><div class="p-5 cursor-pointer flex gap-4 items-start" onclick="toggleTopic('${t.id}')"><div class="mt-1 p-3 rounded-xl bg-gray-50 ${t.color}"><i data-lucide="${t.icon}" width="24"></i></div><div class="flex-1"><div class="flex justify-between items-center mb-1"><h3 class="font-bold text-gray-800">${t.title}</h3><i data-lucide="chevron-right" width="16" class="text-gray-400 transition-transform ${state.expandedTopicId===t.id?'rotate-90':''}"></i></div><p class="text-sm text-gray-500 line-clamp-2">${t.description}</p></div></div>${state.expandedTopicId===t.id ? `<div class="px-5 pb-5 pt-2 border-t border-gray-50 ml-16"><p class="text-sm text-gray-600 mb-3">${t.details}</p><button onclick="openArticle('${t.id}')" class="text-rose-600 font-bold text-sm flex items-center gap-1 hover:gap-2 transition-all">Read Full Article <i data-lucide="arrow-right" width="16"></i></button></div>`:''}</div>`).join('')}</div></div>`; }
        function renderArticleModal() { const t=HEALTH_TOPICS.find(x=>x.id===state.activeArticle); return `<div class="fixed inset-0 bg-white z-50 flex flex-col fade-in"><div class="p-6 border-b flex justify-between items-center sticky top-0 bg-white/90 backdrop-blur"><button onclick="closeArticle()" class="p-2 hover:bg-gray-100 rounded-full"><i data-lucide="arrow-left"></i></button><div class="flex items-center gap-2 font-bold text-gray-800"><i data-lucide="${t.icon}" class="${t.color}" width="20"></i> ${t.title}</div><div class="w-10"></div></div><div class="flex-1 overflow-y-auto p-6 max-w-3xl mx-auto w-full prose prose-rose">${t.fullArticle}</div></div>`; }

        // --- SERVICES ---
        function renderServicesView() {
            if(state.serviceView==='doctors') return renderDoctorsList();
            if(state.serviceView==='pharmacy') return renderPharmacyStore();
            if(state.serviceView==='cart') return renderCart();
            if(state.serviceView==='chat') return renderDoctorChat();
            return renderServicesMenu();
        }

        function renderServicesMenu() {
            return `<div class="space-y-6 fade-in pb-20"><h2 class="text-2xl font-bold text-gray-800">Healthcare Services</h2><div class="grid gap-4"><button onclick="setServiceView('doctors')" class="bg-white p-6 rounded-3xl shadow-sm border border-gray-100 flex items-center gap-6 hover:shadow-md transition-all text-left group"><div class="bg-blue-50 p-4 rounded-2xl text-blue-600 group-hover:scale-110 transition-transform"><i data-lucide="stethoscope" width="32" height="32"></i></div><div class="flex-1"><h3 class="font-bold text-lg text-gray-800">Find a Doctor</h3><p class="text-sm text-gray-500">Book appointments & consult online</p></div><div class="bg-gray-50 p-2 rounded-full"><i data-lucide="chevron-right" class="text-gray-400"></i></div></button><button onclick="setServiceView('pharmacy')" class="bg-white p-6 rounded-3xl shadow-sm border border-gray-100 flex items-center gap-6 hover:shadow-md transition-all text-left group"><div class="bg-green-50 p-4 rounded-2xl text-green-600 group-hover:scale-110 transition-transform"><i data-lucide="shopping-bag" width="32" height="32"></i></div><div class="flex-1"><h3 class="font-bold text-lg text-gray-800">Medical Store</h3><p class="text-sm text-gray-500">Order medicines & essentials</p></div><div class="bg-gray-50 p-2 rounded-full"><i data-lucide="chevron-right" class="text-gray-400"></i></div></button></div></div>`;
        }

        function renderPharmacyStore() {
            const cartCount = state.cart.reduce((a,b)=>a+b.qty,0);
            return `<div class="space-y-6 fade-in h-full flex flex-col"><div class="flex items-center justify-between"><div class="flex items-center gap-2"><button onclick="setServiceView('menu')" class="p-2 hover:bg-gray-100 rounded-full"><i data-lucide="arrow-left"></i></button><h2 class="text-xl font-bold text-gray-800">Medical Store</h2></div><button onclick="setServiceView('cart')" class="relative p-2 bg-white border rounded-xl shadow-sm hover:bg-gray-50"><i data-lucide="shopping-cart" class="text-gray-700"></i>${cartCount>0?`<span class="cart-badge">${cartCount}</span>`:''}</button></div><div class="relative"><input type="text" placeholder="Search medicines..." class="w-full pl-10 pr-4 py-3 rounded-2xl border-none bg-white shadow-sm focus:ring-2 focus:ring-rose-500 outline-none text-sm"/><i data-lucide="search" class="absolute left-3 top-3.5 text-gray-400 w-5"></i></div><div class="grid grid-cols-2 gap-4 pb-24 overflow-y-auto">${MEDICINES.map(m=>`<div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 flex flex-col"><img src="${m.image}" class="w-full h-32 object-contain bg-gray-50 rounded-xl mb-3 p-2"/><h3 class="font-bold text-sm text-gray-800 line-clamp-1 mb-1">${m.name}</h3><p class="text-xs text-gray-500 mb-3">${m.type}</p><div class="mt-auto flex items-center justify-between"><span class="font-bold text-rose-600">â‚¹${m.price}</span><button onclick='addToCart(${JSON.stringify(m)})' class="bg-gray-900 text-white p-2 rounded-lg hover:bg-gray-700 transition-colors"><i data-lucide="plus" width="16"></i></button></div></div>`).join('')}</div><button onclick="showNotification('Request sent!')" class="fixed bottom-24 right-6 bg-rose-600 text-white px-6 py-3 rounded-full shadow-xl flex items-center gap-2 font-bold z-40 hover:bg-rose-700 transition-transform active:scale-95"><i data-lucide="file-plus"></i> Request Item</button></div>`;
        }

        function renderCart() {
            const total = state.cart.reduce((a,b)=>a+(b.price*b.qty),0);
            return `<div class="space-y-6 fade-in h-full flex flex-col pb-6"><div class="flex items-center gap-2"><button onclick="setServiceView('pharmacy')" class="p-2 hover:bg-gray-100 rounded-full"><i data-lucide="arrow-left"></i></button><h2 class="text-xl font-bold text-gray-800">Your Cart</h2></div><div class="flex-1 overflow-y-auto space-y-4">${state.cart.length===0 ? `<div class="text-center py-20 text-gray-400"><i data-lucide="shopping-bag" width="64" class="mx-auto mb-4 opacity-30"></i><p>Your cart is empty</p></div>` : state.cart.map(i=>`<div class="bg-white p-4 rounded-2xl border border-gray-100 flex justify-between items-center"><div class="flex gap-4 items-center"><div class="w-12 h-12 bg-gray-50 rounded-lg flex items-center justify-center"><img src="${i.image}" class="w-8 h-8"/></div><div><h4 class="font-bold text-gray-800">${i.name}</h4><p class="text-xs text-gray-500">â‚¹${i.price} x ${i.qty}</p></div></div><div class="flex items-center gap-4"><span class="font-bold text-gray-800">â‚¹${i.price*i.qty}</span><button onclick="removeFromCart(${i.id})" class="text-gray-400 hover:text-red-500"><i data-lucide="trash-2" width="18"></i></button></div></div>`).join('')}</div>${state.cart.length>0 ? `<div class="bg-white p-6 rounded-3xl shadow-xl border border-gray-100"><div class="flex justify-between mb-6"><span class="text-gray-500">Total Amount</span><span class="text-2xl font-bold text-gray-900">â‚¹${total}</span></div><button onclick="placeOrder()" class="w-full bg-gray-900 text-white py-4 rounded-2xl font-bold hover:bg-black transition-transform active:scale-95">Place Order</button></div>` : ''}</div>`;
        }

        function renderDoctorsList() {
            return `<div class="space-y-4 fade-in pb-20"><div class="flex items-center gap-2 mb-2"><button onclick="setServiceView('menu')" class="p-2 hover:bg-gray-100 rounded-full"><i data-lucide="arrow-left"></i></button><h2 class="text-xl font-bold text-gray-800">Find Specialists</h2></div><div class="grid gap-4">${DOCTORS.map(d=>`<div class="bg-white p-4 rounded-2xl border border-gray-100 shadow-sm hover:shadow-md transition-shadow flex gap-4 items-center"><img src="${d.image}" class="w-16 h-16 rounded-full bg-gray-50 object-cover border border-gray-100"/><div class="flex-1"><div class="flex justify-between items-start mb-1"><h3 class="font-bold text-gray-900">${d.name}</h3><span class="flex items-center text-xs font-bold text-amber-500 bg-amber-50 px-2 py-0.5 rounded-full"><i data-lucide="star" width="12" class="fill-current mr-1"></i>${d.rating}</span></div><p class="text-sm text-rose-600 font-medium mb-2">${d.specialty}</p><div class="flex gap-2"><button onclick="openDoctorChat(${d.id})" class="flex-1 bg-gray-900 text-white py-2 rounded-lg text-xs font-bold hover:bg-black transition-colors">Message</button><button class="px-3 py-2 border border-gray-200 rounded-lg hover:bg-gray-50"><i data-lucide="video" width="16" class="text-gray-600"></i></button></div></div></div>`).join('')}</div></div>`;
        }

        // --- DOCTOR CHAT ---
        function renderDoctorChat() {
            const d = state.activeDoctor;
            const msgs = state.doctorChatMessages[d.id] || [];
            const inputVal = document.getElementById('doc-input')?.value || '';
            const icon = inputVal.trim() ? 'send' : 'mic';
            return `
                <div class="flex flex-col h-[calc(100vh-100px)] bg-white rounded-3xl overflow-hidden shadow-xl border border-gray-100 fade-in fixed inset-0 z-50 m-0 md:m-4 md:relative">
                    <div class="bg-white p-4 flex items-center gap-3 border-b border-gray-100">
                        <button onclick="setServiceView('doctors')" class="p-2 hover:bg-gray-100 rounded-full"><i data-lucide="arrow-left"></i></button>
                        <img src="${d.image}" class="w-10 h-10 rounded-full border"/>
                        <div class="flex-1"><h3 class="font-bold text-sm">${d.name}</h3><div class="flex items-center gap-1"><span class="w-2 h-2 bg-green-500 rounded-full"></span><span class="text-xs text-gray-500">Online</span></div></div>
                        <button onclick="startCall('audio')" class="p-2 hover:bg-gray-100 rounded-full"><i data-lucide="phone" class="text-gray-600"></i></button>
                        <button onclick="startCall('video')" class="p-2 hover:bg-gray-100 rounded-full"><i data-lucide="video" class="text-gray-600"></i></button>
                    </div>
                    <div id="doc-chat-area" class="flex-1 overflow-y-auto p-4 space-y-4 bg-[#f0f2f5]">
                        ${msgs.map(m=>`<div class="flex flex-col ${m.sender==='me'?'items-end':'items-start'}"><div class="msg-bubble ${m.sender==='me'?'msg-sent':'msg-received'}">${m.type==='image'?`<img src="${m.content}" class="rounded-lg w-full max-w-[200px]"/>`:m.type==='audio'?`<div class="flex gap-3 items-center"><div class="w-8 h-8 rounded-full bg-white/20 flex items-center justify-center"><i data-lucide="play" width="14" fill="currentColor"></i></div><div class="w-24 h-1 bg-current opacity-30 rounded-full"></div><span class="text-xs">0:05</span></div>`:m.type==='document'?`<div class="flex gap-3 items-center"><div class="p-2 bg-gray-100 rounded text-gray-500"><i data-lucide="file-text"></i></div><span class="underline">${m.text}</span></div>`:m.text}<span class="text-[10px] opacity-70 block text-right mt-1">${new Date(m.ts).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</span></div></div>`).join('')}
                    </div>
                    <div class="p-3 bg-white border-t border-gray-100 flex items-end gap-2">
                        <div class="flex-1 bg-gray-100 rounded-2xl flex items-center px-1 py-1">
                            <input id="doc-input" class="bg-transparent flex-1 p-3 text-sm outline-none min-w-0" placeholder="Message..." oninput="toggleSendIcon()" onkeypress="if(event.key==='Enter')handleMainAction()"/>
                            <input type="file" id="hidden-file-input" class="hidden" onchange="handleFileInputChange(this)"/>
                            <button onclick="attachFile()" class="p-2 text-gray-500 hover:text-gray-800"><i data-lucide="paperclip" width="20"></i></button>
                            <button onclick="takePhoto()" class="p-2 text-gray-500 hover:text-gray-800"><i data-lucide="camera" width="20"></i></button>
                        </div>
                        <button id="main-chat-btn" onclick="handleMainAction()" class="w-12 h-12 bg-rose-500 hover:bg-rose-600 text-white rounded-full flex items-center justify-center shadow-md transition-transform active:scale-95"><i data-lucide="${icon}" width="20"></i></button>
                    </div>
                </div>
            `;
        }

        // --- CALL OVERLAY ---
        function renderCallOverlay() {
            const isVideo = state.callType === 'video';
            const container = document.getElementById('video-call-container');
            container.innerHTML = `
                <div class="fixed inset-0 bg-gray-900 z-[60] flex flex-col items-center justify-center animate-in fade-in zoom-in duration-300">
                    <div class="absolute top-10 left-0 right-0 text-center text-white z-10"><h2 class="text-2xl font-bold mb-1">${state.activeDoctor.name}</h2><p class="animate-pulse text-sm">${isVideo?'Video':'Voice'} Calling...</p></div>
                    <div class="w-full h-full flex items-center justify-center relative">
                        ${ (!isVideo || state.isVideoPaused) ? `<div class="flex flex-col items-center"><img src="${state.activeDoctor.image}" class="w-32 h-32 rounded-full border-4 border-rose-500 shadow-2xl animate-pulse" /></div>` : `<div class="w-full h-full bg-gray-800 flex items-center justify-center text-white"><p>Remote Video Stream</p></div>` }
                    </div>
                    ${ isVideo && !state.isVideoPaused ? `<div class="absolute bottom-32 right-4 w-32 h-48 bg-black rounded-xl border-2 border-white overflow-hidden shadow-2xl"><video id="localVideo" autoplay muted playsinline class="w-full h-full object-cover transform -scale-x-100"></video></div>` : '' }
                    <div class="absolute bottom-10 flex justify-center gap-6 w-full">
                        <button onclick="toggleMute()" class="${state.isMuted ? 'bg-white text-red-600 call-btn-active' : 'call-btn-inactive'} p-4 rounded-full call-btn"><i data-lucide="${state.isMuted ? 'mic-off' : 'mic'}" width="24"></i></button>
                        <button onclick="endCall()" class="bg-red-600 p-4 rounded-full text-white shadow-lg hover:bg-red-700 transform hover:scale-110 call-btn"><i data-lucide="phone-off" width="32"></i></button>
                        ${ isVideo ? `<button onclick="toggleVideo()" class="${state.isVideoPaused ? 'bg-white text-red-600 call-btn-active' : 'call-btn-inactive'} p-4 rounded-full call-btn"><i data-lucide="${state.isVideoPaused ? 'video-off' : 'video'}" width="24"></i></button>` : '' }
                    </div>
                </div>
            `;
            if (isVideo && !state.isVideoPaused) {
                setTimeout(() => {
                    const video = document.getElementById('localVideo');
                    if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                        navigator.mediaDevices.getUserMedia({ video: true, audio: true })
                            .then(stream => {
                                state.localStream = stream;
                                if(video) video.srcObject = stream;
                            })
                            .catch(err => { console.error(err); showNotification("Camera access denied"); });
                    }
                }, 100);
            }
        }

        function renderChatWidget() {
            const c = document.getElementById('chat-container');
            if(state.chatOpen) {
                c.className = "fixed bottom-24 right-4 z-50 md:bottom-10 md:right-10 md:w-80";
                c.innerHTML = `<div class="bg-white rounded-2xl shadow-2xl w-full md:w-80 h-96 flex flex-col overflow-hidden border border-rose-100 fade-in"><div class="bg-rose-500 p-4 flex justify-between items-center text-white"><h3 class="font-semibold flex items-center gap-2"><i data-lucide="message-circle" width="18"></i> Support Chat</h3><button onclick="toggleChat()"><i data-lucide="x" width="18"></i></button></div><div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-3 bg-gray-50 scrollbar-hide">${state.chatMessages.map(msg => `<div class="flex ${msg.sender === 'user' ? 'justify-end' : 'justify-start'}"><div class="max-w-[80%] p-3 rounded-lg text-sm ${msg.sender === 'user' ? 'bg-rose-500 text-white rounded-br-none' : 'bg-white text-gray-800 shadow-sm rounded-bl-none border border-gray-100'}">${msg.text}</div></div>`).join('')}</div><div class="p-3 bg-white border-t border-gray-100 flex gap-2"><input type="text" id="ai-input" class="flex-1 border border-gray-300 rounded-full px-4 py-2 text-sm focus:outline-none focus:border-rose-500" placeholder="Type a message..." onkeypress="if(event.key === 'Enter') sendAIMessage()" /><button onclick="sendAIMessage()" class="bg-rose-500 text-white p-2 rounded-full hover:bg-rose-600"><i data-lucide="send" width="16"></i></button></div></div>`;
                setTimeout(() => { const el = document.getElementById('chat-messages'); if(el) el.scrollTop = el.scrollHeight; }, 10);
            } else {
                c.className = "fixed bottom-10 right-10 z-50 hidden md:block";
                c.innerHTML = `<button onclick="toggleChat()" class="bg-rose-500 hover:bg-rose-600 text-white p-4 rounded-full shadow-lg transition-transform hover:scale-110 flex items-center justify-center"><i data-lucide="message-circle" width="28"></i></button>`;
            }
            lucide.createIcons();
        }

        // --- HANDLERS ---
        function handleSendOtp(e) { e.preventDefault(); if(!state.authName) return showNotification("Enter Name"); state.authLoading=true; render(); setTimeout(()=>{state.authStep=2;state.authLoading=false;showNotification("OTP: 1234");render()},1000); }
        function handleVerifyOtp(e) { e.preventDefault(); if(state.authOtp==='1234'){state.user={name:state.authName,address:state.authAddress}; render();} else showNotification("Invalid"); }
        function fetchLocation() { showNotification("Locating..."); setTimeout(()=>{state.authAddress="New York, USA"; render()},500); }
        function setActiveTab(t) { state.activeTab=t; render(); }
        function setServiceView(v) { state.serviceView=v; render(); }
        function openDoctorChat(id) { state.activeDoctor=DOCTORS.find(d=>d.id===id); state.serviceView='chat'; render(); setTimeout(()=>document.getElementById('doc-chat-area')?.scrollTo(0,9999),50); }
        
        function toggleSendIcon() {
            const val = document.getElementById('doc-input').value.trim();
            const btn = document.getElementById('main-chat-btn');
            if(btn) { btn.innerHTML = val.length > 0 ? '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-send"><path d="m22 2-7 20-4-9-9-4Z"/><path d="M22 2 11 13"/></svg>' : '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-mic"><path d="12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" x2="12" y1="19" y2="22"/><line x1="8" x2="16" y1="22" y2="22"/></svg>'; }
        }
        
        function handleMainAction() {
            const input = document.getElementById('doc-input');
            if(input.value.trim()) sendDoctorMessage(); else sendVoiceNote();
        }
        function sendDoctorMessage() {
            const t = document.getElementById('doc-input').value.trim(); if(!t) return;
            const id = state.activeDoctor.id; if(!state.doctorChatMessages[id]) state.doctorChatMessages[id]=[];
            state.doctorChatMessages[id].push({sender:'me', text:t, type:'text', ts:Date.now()});
            document.getElementById('doc-input').value=''; toggleSendIcon(); render();
            setTimeout(()=>{ state.doctorChatMessages[id].push({sender:'them', text:"Okay, I understand.", type:'text', ts:Date.now()}); render(); }, 1000);
        }
        function sendVoiceNote() {
            showNotification("Recording..."); setTimeout(()=>{
                const id=state.activeDoctor.id; if(!state.doctorChatMessages[id]) state.doctorChatMessages[id]=[];
                state.doctorChatMessages[id].push({sender:'me', type:'audio', ts:Date.now()}); render();
            },1000);
        }
        function attachFile() { const i=document.getElementById('hidden-file-input'); i.setAttribute('accept','*/*'); i.click(); }
        function takePhoto() { const i=document.getElementById('hidden-file-input'); i.setAttribute('accept','image/*'); i.click(); }
        function handleFileInputChange(input) {
            const file = input.files[0]; if(!file) return;
            const id = state.activeDoctor.id; if(!state.doctorChatMessages[id]) state.doctorChatMessages[id]=[];
            if(file.type.startsWith('image/')) {
                const r = new FileReader(); r.onload=(e)=>{state.doctorChatMessages[id].push({sender:'me',type:'image',content:e.target.result,ts:Date.now()});render()}; r.readAsDataURL(file);
            } else {
                state.doctorChatMessages[id].push({sender:'me',type:'document',text:file.name,ts:Date.now()}); render();
            }
        }

        function startCall(type) { state.callType=type; state.isVideoCallActive=true; state.isMuted=false; state.isVideoPaused=false; render(); }
        function toggleMute() { state.isMuted=!state.isMuted; if(state.localStream) state.localStream.getAudioTracks().forEach(t=>t.enabled=!state.isMuted); renderCallOverlay(); }
        function toggleVideo() { state.isVideoPaused=!state.isVideoPaused; if(state.localStream) state.localStream.getVideoTracks().forEach(t=>t.enabled=!state.isVideoPaused); renderCallOverlay(); }
        function endCall() { state.isVideoCallActive=false; if(state.localStream) state.localStream.getTracks().forEach(t=>t.stop()); state.localStream=null; document.getElementById('video-call-container').innerHTML=''; render(); }
        function addWater(val) { if(val === state.waterIntake) state.waterIntake = val - 1; else state.waterIntake = val; render(); }
        function setMood(m) { state.dailyMood=m; render(); showNotification("Mood Logged: "+m); }
        function addToCart(item) { const ex=state.cart.find(i=>i.id===item.id); if(ex) ex.qty++; else state.cart.push({...item,qty:1}); showNotification("Added to Cart"); render(); }
        function removeFromCart(id) { state.cart=state.cart.filter(i=>i.id!==id); render(); }
        function placeOrder() { if(state.cart.length===0)return showNotification("Cart Empty"); state.cart=[]; state.serviceView='pharmacy'; showNotification("Order Placed!"); render(); }
        function toggleTopic(id) { state.expandedTopicId = state.expandedTopicId===id?null:id; render(); }
        function openArticle(id) { state.activeArticle=id; render(); }
        function closeArticle() { state.activeArticle=null; render(); }
        function toggleChat() { state.chatOpen=!state.chatOpen; renderChatWidget(); }
        function sendAIMessage() { const t=document.getElementById('ai-input').value; if(!t)return; state.chatMessages.push({id:Date.now(),sender:'user',text:t}); document.getElementById('ai-input').value=''; renderChatWidget(); setTimeout(()=>{state.chatMessages.push({id:Date.now(),sender:'bot',text:"I can help with that! Check the 'Learn' section for detailed guides."}); renderChatWidget();},800); }
        function closeModal() { state.selectedDateDetails=null; render(); }
        function handleDateClick(d) { state.selectedDateDetails={day:d, data:{flow:'',symptoms:[]}}; render(); }
        function updateModalData(k,v) { state.selectedDateDetails.data[k]=v; render(); }
        function saveLog() { state.cycleData[`${state.currentDate.getFullYear()}-${state.currentDate.getMonth()}-${state.selectedDateDetails.day}`]=state.selectedDateDetails.data; closeModal(); }
        function changeMonth(d) { state.currentDate.setMonth(state.currentDate.getMonth()+d); render(); }
        function logPeriodStartToday() { const d=new Date(); state.cycleData[`${d.getFullYear()}-${d.getMonth()}-${d.getDate()}`]={flow:'Medium'}; render(); showNotification("Logged!"); }
        function toggleSymptom(s) { const arr=state.selectedDateDetails.data.symptoms||[]; if(arr.includes(s)) state.selectedDateDetails.data.symptoms=arr.filter(x=>x!==s); else state.selectedDateDetails.data.symptoms=[...arr,s]; render(); }

        render();
    </script>
</body>
</html>